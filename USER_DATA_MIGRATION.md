# Миграция данных пользователей

## Описание изменений

В форму регистрации добавлены обязательные поля:

- **Имя** (`first_name`)
- **Фамилия** (`last_name`)
- **Дата рождения** (`birth_date`)

Поле "Никнейм" удалено из формы регистрации.

## Миграция существующих пользователей

### Вариант 1: Через SQL функцию (рекомендуется)

1. Откройте Supabase Dashboard
2. Перейдите в SQL Editor
3. Выполните SQL скрипт из файла `user_data_migration.sql`
4. Функция `update_user_metadata()` будет создана

После создания функции вы можете обновить метаданные пользователей:

```sql
-- Обновление одного пользователя
SELECT update_user_metadata(
    'user-id-here',      -- UUID пользователя
    'Иван',              -- Имя
    'Иванов',            -- Фамилия
    '1990-01-01'         -- Дата рождения
);
```

### Вариант 2: Через код приложения

Добавьте функцию обновления метаданных пользователя в API и вызывайте её через админ-панель:

```typescript
// Пример в src/features/admin/api.ts
export async function updateUserMetadata(
  userId: string,
  data: { first_name?: string; last_name?: string; birth_date?: string }
): Promise<void> {
  const { error } = await supabase.rpc("update_user_metadata", {
    p_user_id: userId,
    p_first_name: data.first_name || null,
    p_last_name: data.last_name || null,
    p_birth_date: data.birth_date || null,
  });
  if (error) throw error;
}
```

### Вариант 3: Ручное заполнение

Для небольшого количества пользователей можно вручную заполнить данные через админ-панель, когда будет добавлена функциональность редактирования метаданных пользователя.

## Новые пользователи

Все новые пользователи, зарегистрированные после обновления формы, автоматически будут иметь заполненные поля:

- Имя
- Фамилия
- Дата рождения

Эти данные сохраняются в метаданных пользователя Supabase Auth (`raw_user_meta_data`).

## Технические детали

### Структура данных

Данные хранятся в JSONB формате в поле `raw_user_meta_data` таблицы `auth.users`:

```json
{
  "first_name": "Иван",
  "last_name": "Иванов",
  "birth_date": "1990-01-01T00:00:00.000Z",
  "phone": "+79001234567",
  "role": "user"
}
```

### Обратная совместимость

- Существующие пользователи будут иметь `null` значения для новых полей
- Код приложения корректно обрабатывает отсутствие данных
- В UI отображается `-` для пустых полей

## Проверка после миграции

1. Убедитесь, что новые пользователи успешно регистрируются с заполненными полями
2. Проверьте, что существующие пользователи отображаются корректно (с `-` для пустых полей)
3. Админ-панель должна отображать новые колонки с данными

## Откат изменений

Если потребуется откатить изменения:

1. Удалите новые обязательные проверки из `src/pages/AuthPage.tsx`
2. Уберите новые колонки из админ-панели
3. Данные в базе останутся, но не будут обязательными
